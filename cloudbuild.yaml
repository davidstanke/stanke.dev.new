steps: 
  - name: gcr.io/$PROJECT_ID/hugo
    args: [
      "-s","hugo",
      "-d","../public"
      ]

 # create a docker container that can run on cloud run
  - name: gcr.io/cloud-builders/docker
    args: ["build", "-f", "tools/preview_container/Dockerfile", "-t", "gcr.io/$PROJECT_ID/stanke-dev:$SHORT_SHA", "."]
  - name: gcr.io/cloud-builders/docker
    args: ["push","gcr.io/$PROJECT_ID/stanke-dev:$SHORT_SHA"]

  # deploy to Cloud Run
  - name: gcr.io/cloud-builders/gcloud@sha256:ffc20cf6058d8622d98ecfbfbfb4f2dc50bc2dfff245511a270e0098f885a7db
    entrypoint: gcloud
    args: 
      - alpha 
      - run 
      - deploy 
      - stanke-dev 
      - --image=gcr.io/stanke-dev/stanke-dev:$SHORT_SHA
      - --platform=managed 
      - --region=us-central1 
      - --allow-unauthenticated 
      - --revision-suffix=commit-$SHORT_SHA
      
  # Route traffic to new version
  - name: gcr.io/cloud-builders/gcloud@sha256:ffc20cf6058d8622d98ecfbfbfb4f2dc50bc2dfff245511a270e0098f885a7db
    entrypoint: gcloud
    args: 
      - alpha
      - run 
      - services
      - update-traffic 
      - stanke-dev 
      - --to-revisions=commit-$SHORT_SHA=100
