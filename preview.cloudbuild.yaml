steps:
  - name: gcr.io/$PROJECT_ID/hugo
    args: [
      "-s","hugo",
      "-d","../public"
      ]

  # create a docker container that can run on cloud run
  - name: gcr.io/cloud-builders/docker
    args: ["build", "-f", "tools/preview_container/Dockerfile", "-t", "gcr.io/$PROJECT_ID/stanke-dev:pr-$_PR_NUMBER-$SHORT_SHA", "."]
  - name: gcr.io/cloud-builders/docker
    args: ["push","gcr.io/$PROJECT_ID/stanke-dev:pr-$_PR_NUMBER-$SHORT_SHA"]

  # deploy to Cloud Run
  - name: gcr.io/cloud-builders/gcloud@sha256:ffc20cf6058d8622d98ecfbfbfb4f2dc50bc2dfff245511a270e0098f885a7db
    entrypoint: gcloud
    args: 
      - alpha 
      - run 
      - deploy 
      - stanke-dev 
      - --revision-suffix=pr-$_PR_NUMBER-$SHORT_SHA
      - --image=gcr.io/stanke-dev/stanke-dev:pr-$_PR_NUMBER-$SHORT_SHA
      - --platform=managed 
      - --region=us-central1 
      - --allow-unauthenticated 
      - --no-traffic
  
  # Set Cloud Run tag
  - name: gcr.io/cloud-builders/gcloud@sha256:ffc20cf6058d8622d98ecfbfbfb4f2dc50bc2dfff245511a270e0098f885a7db
    entrypoint: gcloud
    args: 
      - alpha 
      - run 
      - services
      - update-traffic 
      - stanke-dev 
      - --update-tags=pr-$_PR_NUMBER=stanke-dev-pr-$_PR_NUMBER-$SHORT_SHA
      - --platform=managed 
      - --region=us-central1

  # add preview URL as a status check
  - name: 'gcr.io/${PROJECT_ID}/pr-status-poster'
    args: [
          '--project-id', '${PROJECT_ID}', 
          '--repo-name', 'davidstanke/${REPO_NAME}',
          '--commit-sha', '${COMMIT_SHA}',
          '--target-url', 'https://pr-$_PR_NUMBER---stanke-dev-t63odkzjiq-uc.a.run.app'
          ]
